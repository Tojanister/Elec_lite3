<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>ELECTRON</title>
</head>
<body>
    <nav>
        <div class="nav-wrapper">
            <a id="backBtn" class="waves-effect waves-light"><i class="material-icons left">keyboard_arrow_left</i>Vissza</a>
          <a href="#" class="brand-logo center">Munkavállalók listája</a>
        </div>
      </nav>

      <ul></ul>
      
      <div class="fixed-action-btn">
        <a class="btn-floating btn-large">
          <i class="large material-icons">person_add</i>
        </a>
        <!--
        <ul>
          <li><a class="btn-floating red"><i class="material-icons">insert_chart</i></a></li>
          <li><a class="btn-floating yellow darken-1"><i class="material-icons">format_quote</i></a></li>
          <li><a class="btn-floating green"><i class="material-icons">publish</i></a></li>
          <li><a class="btn-floating blue"><i class="material-icons">attach_file</i></a></li>
        </ul>
        -->
      </div>

    <script>
        const backButton = document.getElementById("backBtn");
        backButton.addEventListener('click', backToLanding)

        function backToLanding(e){
            e.preventDefault();
            ipcRenderer.send('routing:landing');
        }

        const addButton = document.querySelector(".fixed-action-btn>.btn-floating>.material-icons");
        addButton.addEventListener('click', openAddWindow)

        function openAddWindow(){
            ipcRenderer.send('routing:addWindow');
        }

        var sqlite3 = require('sqlite3').verbose();

        (function initItems(){
            let db = new sqlite3.Database('./Database/testDB.db', (err) => {
                if (err) {
                    var fs = require('fs');
                    fs.open('./Database/testDB.db', 'w', (err, file) => {
                        if (err) throw err;
                        fs.close(file);
                    });
                }
            });    

            db.run("CREATE TABLE if not exists Employees (id INTEGER PRIMARY KEY AUTOINCREMENT, first_name TEXT NOT NULL, last_name TEXT NOT NULL, birth_date TEXT, email TEXT)");
            
            const sql = "SELECT * FROM Employees";
            db.all(sql, [], (err, rows) => {
                if (err) {
                    console.log(err);
                }else{
                    rows.forEach((row) => {
                        //createListItem(row.id,row.list_items);
                        createListItem(row.id,row.first_name + ' ' + row.last_name);
                    });
                }
            });

            db.close();        
        })();

        function InsertDB(person){
            
            let db = new sqlite3.Database('./Database/testDB.db', (err) => {
                if (err) {
                    console.error(err.message);
                }
            });       
            //db.run("CREATE TABLE if not exists Employees (id INTEGER PRIMARY KEY AUTOINCREMENT, first_name TEXT NOT NULL, last_name TEXT NOT NULL, birth_date TEXT, email TEXT)");
            let stmt = db.prepare("INSERT INTO Employees (first_name, last_name, birth_date, email) VALUES (?, ?, ?, ?)");            
            stmt.run(person, function (err) {
                if (err) throw err;

                let fullName = person[0] + ' ' + person[1];
                createListItem(this.lastID, fullName);
            });
            
            stmt.finalize();
            db.close();
        }

        function UpdateDB(person){
            
            let db = new sqlite3.Database('./Database/testDB.db', (err) => {
                if (err) {
                    console.error(err.message);
                }
            });
            let stmt = db.prepare("UPDATE Employees SET first_name = ?, last_name = ?, birth_date = ?, email = ? WHERE id = ?");         

            stmt.run([person.first_name, person.last_name, person.birth_date, person.email, person.id ], function (err) {
                if (err) throw err;

                console.log('asdasdasdasdasd');
            });            
            
            stmt.finalize();
            db.close();
        }

        const {ipcRenderer} = require('electron');
        const ul = document.querySelector('ul');

        ipcRenderer.on('employee:add', (e, personalData) => {
            InsertDB(personalData);
        });

        ipcRenderer.on('employee:edit', (e, personalData) => {
            UpdateDB(personalData);
        });

        ipcRenderer.on('item:clear', () => {
            ul.innerHTML = '';
            ul.className = '';
        });

        function removeItem(elem){

            const itemToClear = elem;
            itemToClear.remove();

            if(!ul.children.length){
                ul.className = '';
            }

            let db = new sqlite3.Database('./Database/testDB.db', (err) => {
                if (err)  throw err;
            }); 

            let stmt = db.prepare("DELETE FROM Employees WHERE id = (?)");
            stmt.run(itemToClear.id, function (err) {
                if (err) throw err;
            });
            
            stmt.finalize();
            db.close();

        };

        function openEditPage(elem){

            console.log(elem.id)

            let db = new sqlite3.Database('./Database/testDB.db', (err) => {
                if (err) {
                    console.log(err);
                }
            });    
            //'id, first_name, last_name, birth_date, email'    
            //let stmt = db.prepare("SELECT * FROM Employees WHERE id = ?");
            let sql = "SELECT * FROM Employees WHERE id = ?";
            db.get(sql, [elem.id], (err, row)=>{
                if (err) {
                    console.log(err);
                }else{
                    ipcRenderer.send('routing:editPage', row);                    
                }
            });

            db.close();  
        }

        function createListItem(db_id, item){
        
            let tempRow = `<li class="collection-item" id="${db_id}">
                <label>
                    <span>${item}</span>
                </label>
                <span class="badge">
                    <i id="editBtn" class="material-icons" onclick='openEditPage(this.closest("li"));'>edit</i>
                    <i id="clearItem" class="material-icons" onclick='removeItem(this.closest("li"));'>clear</i>
                </span>
            </li>`
            const ul = document.querySelector('ul');
            ul.className = 'collection';
            ul.innerHTML += tempRow;
        }

    </script>
</body>
</html>
