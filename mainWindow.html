<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>ELECTRON</title>
</head>
<body>
    <nav>
        <div class="nav-wrapper">
            <a id="back_button" class="waves-effect waves-light"><i class="material-icons left">keyboard_arrow_left</i>Vissza</a>
          <a href="#" class="brand-logo center">SOROLD FEL</a>
        </div>
      </nav>

      <ul></ul>

    <script>
        const backButton = document.getElementById("back_button");
        backButton.addEventListener('click', backToLanding)

        function backToLanding(e){
            e.preventDefault();
            ipcRenderer.send('routing:landing');
        }

        var sqlite3 = require('sqlite3').verbose();

        (function initItems(){
            let db = new sqlite3.Database('./Database/testDB.db', (err) => {
                if (err) {
                    var fs = require('fs');
                    fs.open('./Database/testDB.db', 'w', (err, file) => {
                        if (err) throw err;
                        fs.close(file);
                    });
                    /*
                    db = new sqlite3.Database('./Database/testDB.db');
                    db.run("CREATE TABLE if not exists Employees (id INTEGER PRIMARY KEY AUTOINCREMENT, first_name TEXT NOT NULL, last_name TEXT NOT NULL, birth_date TEXT, email TEXT)");
                    console.log("asd",db)
                    */
                }
            });    
            console.log("db:",db);
            db.run("CREATE TABLE if not exists Employees (id INTEGER PRIMARY KEY AUTOINCREMENT, first_name TEXT NOT NULL, last_name TEXT NOT NULL, birth_date TEXT, email TEXT)");
            
            const sql = "SELECT * FROM Employees";
            db.all(sql, [], (err, rows) => {
                if (err) {
                    console.log(err);
                }else{
                    rows.forEach((row) => {
                        //createListItem(row.id,row.list_items);
                        createListItem(row.id,row.first_name + ' ' + row.last_name);
                    });
                }
            });

            db.close();        
        })();

        function InsertDB(person){
            
            let db = new sqlite3.Database('./Database/testDB.db', (err) => {
                if (err) {
                    console.error(err.message);
                }
            });       
            //db.run("CREATE TABLE if not exists Employees (id INTEGER PRIMARY KEY AUTOINCREMENT, first_name TEXT NOT NULL, last_name TEXT NOT NULL, birth_date TEXT, email TEXT)");
            let stmt = db.prepare("INSERT INTO Employees (first_name, last_name, birth_date, email) VALUES (?, ?, ?, ?)");            
            stmt.run(person, function (err) {
                if (err) throw err;

                const fullName = person[0] + person[1];
                createListItem(this.lastID, fullName);
            });
            
            stmt.finalize();
            db.close();
        }
        const {ipcRenderer} = require('electron');
        const ul = document.querySelector('ul');
        /*
        ipcRenderer.on('item:add', (e, item) => {
            InsertDB(item);
        });
        */
        ipcRenderer.on('employee:add', (e, personalData) => {
            InsertDB(personalData);
        });

        ipcRenderer.on('item:clear', () => {
            ul.innerHTML = '';
            ul.className = '';
        });

        function removeItem(e){

            const itemToClear = e.target.closest('li');
            itemToClear.remove();

            if(!ul.children.length){
                ul.className = '';
            }

            let db = new sqlite3.Database('./Database/testDB.db', (err) => {
                if (err)  throw err;
            }); 

            //let stmt = db.prepare("DELETE FROM Lists WHERE id = (?)");
            let stmt = db.prepare("DELETE FROM Employees WHERE id = (?)");
            stmt.run(itemToClear.id, function (err) {
                if (err) throw err;
            });
            
            stmt.finalize();
            db.close();

        };
        
        function createListItem(db_id, item){
        
            let tempRow = `<li class="collection-item" id="${db_id}">
                <label>
                    <span>${item}</span>
                </label>
                <span class="badge">
                    <i class="material-icons">edit</i>
                    <i id="clearItem" class="material-icons">clear</i>
                </span>
            </li>`
            const ul = document.querySelector('ul');
            ul.className = 'collection';
            ul.innerHTML += tempRow;

            let currItem = document.querySelector("li[id*='" + db_id +"'] i[id*='clearItem']");
            currItem.addEventListener('click', removeItem);
        }

    </script>
</body>
</html>
